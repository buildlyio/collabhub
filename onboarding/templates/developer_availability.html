{% extends "base.html" %}

{% block page_title %}Availability & Forge Projects{% endblock %}

{% block page_content %}
<div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-lg p-8 mb-8 text-white">
        <h1 class="text-3xl md:text-4xl font-bold mb-2">Availability & Forge Projects</h1>
        <p class="opacity-90">Manage your availability and start or join Forge projects</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Availability Settings -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <h2 class="text-xl font-bold text-gray-900 mb-6">Availability Settings</h2>
                
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="space-y-6">
                        <!-- Availability Toggles -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="p-4 border rounded-lg">
                                <label class="flex items-start gap-3 cursor-pointer">
                                    <input type="checkbox" name="available_for_public_projects" 
                                           {% if form.instance.available_for_public_projects %}checked{% endif %}
                                           class="mt-1 h-5 w-5 text-indigo-600 rounded">
                                    <div>
                                        <span class="font-medium text-gray-900">Public Forge Projects</span>
                                        <p class="text-sm text-gray-500 mt-1">Available to work on open source Forge projects</p>
                                    </div>
                                </label>
                            </div>
                            
                            <div class="p-4 border rounded-lg">
                                <label class="flex items-start gap-3 cursor-pointer">
                                    <input type="checkbox" name="available_for_customer_work" 
                                           {% if form.instance.available_for_customer_work %}checked{% endif %}
                                           class="mt-1 h-5 w-5 text-indigo-600 rounded">
                                    <div>
                                        <span class="font-medium text-gray-900">Buildly Customer Work</span>
                                        <p class="text-sm text-gray-500 mt-1">Available for paid client projects</p>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- When Can You Start -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{{ form.availability_start.label }}</label>
                            {{ form.availability_start }}
                        </div>

                        <!-- Custom Start Date (shown conditionally) -->
                        <div id="custom_date_field" class="{% if form.instance.availability_start != 'custom' %}hidden{% endif %}">
                            <label class="block text-sm font-medium text-gray-700 mb-1">{{ form.availability_start_date.label }}</label>
                            {{ form.availability_start_date }}
                        </div>

                        <!-- Hours Per Week -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{{ form.hours_per_week.label }}</label>
                            {{ form.hours_per_week }}
                            <p class="mt-1 text-xs text-gray-500">How many hours per week can you dedicate to work?</p>
                        </div>

                        <!-- Additional Notes -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{{ form.availability_notes.label }}</label>
                            {{ form.availability_notes }}
                            <p class="mt-1 text-xs text-gray-500">Any additional details about your availability (timezone, preferred hours, etc.)</p>
                        </div>
                    </div>

                    <div class="mt-6 pt-6 border-t flex justify-between items-center">
                        {% if developer.availability_updated_at %}
                        <span class="text-xs text-gray-500">Last updated: {{ developer.availability_updated_at|date:"M d, Y H:i" }}</span>
                        {% else %}
                        <span></span>
                        {% endif %}
                        <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 font-medium">
                            Save Settings
                        </button>
                    </div>
                </form>
            </div>

            <!-- My Forge Project Requests -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-900">My Forge Project Requests</h2>
                    <a href="{% url 'onboarding:developer_forge_request_create' %}" 
                       class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm font-medium">
                        + Request New Project
                    </a>
                </div>

                {% if project_requests %}
                <div class="space-y-4">
                    {% for req in project_requests %}
                    <div class="border rounded-lg p-4 hover:bg-gray-50">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <h3 class="font-semibold text-gray-900">{{ req.project_name }}</h3>
                                    <span class="px-2 py-0.5 text-xs rounded 
                                        {% if req.status == 'approved' %}bg-green-100 text-green-700
                                        {% elif req.status == 'in_progress' %}bg-blue-100 text-blue-700
                                        {% elif req.status == 'submitted' or req.status == 'under_review' %}bg-yellow-100 text-yellow-700
                                        {% elif req.status == 'rejected' %}bg-red-100 text-red-700
                                        {% elif req.status == 'completed' %}bg-gray-800 text-white
                                        {% else %}bg-gray-100 text-gray-600{% endif %}">
                                        {{ req.get_status_display }}
                                    </span>
                                    <span class="px-2 py-0.5 text-xs bg-indigo-100 text-indigo-700 rounded">
                                        {{ req.get_request_type_display }}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-600 mt-1">{{ req.project_description|truncatewords:30 }}</p>
                                {% if req.needs_team %}
                                <p class="text-xs text-purple-600 mt-2">
                                    ü§ù Recruiting team ({{ req.applications.count }} application{{ req.applications.count|pluralize }})
                                </p>
                                {% endif %}
                            </div>
                            <div class="flex items-center gap-2 ml-4">
                                {% if req.status == 'draft' or req.status == 'submitted' %}
                                <a href="{% url 'onboarding:developer_forge_request_edit' req.id %}" 
                                   class="text-sm text-indigo-600 hover:text-indigo-800">Edit</a>
                                {% endif %}
                                {% if req.needs_team and req.applications.count > 0 %}
                                <a href="{% url 'onboarding:forge_project_manage_applications' req.id %}" 
                                   class="text-sm text-purple-600 hover:text-purple-800">Applications</a>
                                {% endif %}
                                {% if req.status == 'draft' %}
                                <a href="{% url 'onboarding:developer_forge_request_delete' req.id %}" 
                                   class="text-sm text-red-600 hover:text-red-800">Delete</a>
                                {% endif %}
                            </div>
                        </div>
                        {% if req.review_notes %}
                        <div class="mt-3 p-3 bg-yellow-50 rounded text-sm text-yellow-800">
                            <strong>Feedback:</strong> {{ req.review_notes }}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8 text-gray-500">
                    <p class="mb-4">You haven't created any project requests yet.</p>
                    <a href="{% url 'onboarding:developer_forge_request_create' %}" 
                       class="text-indigo-600 hover:text-indigo-800 font-medium">
                        Start your first Forge project ‚Üí
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Current Status Card -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="font-semibold text-gray-900 mb-4">Your Status</h3>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Public Projects</span>
                        {% if developer.available_for_public_projects %}
                        <span class="px-2 py-1 text-xs bg-green-100 text-green-700 rounded">Available</span>
                        {% else %}
                        <span class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded">Not Available</span>
                        {% endif %}
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Customer Work</span>
                        {% if developer.available_for_customer_work %}
                        <span class="px-2 py-1 text-xs bg-green-100 text-green-700 rounded">Available</span>
                        {% else %}
                        <span class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded">Not Available</span>
                        {% endif %}
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Hours/Week</span>
                        <span class="font-medium">{{ developer.hours_per_week }} hrs</span>
                    </div>
                </div>
            </div>

            <!-- Projects Recruiting -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-semibold text-gray-900">Projects Recruiting</h3>
                    <a href="{% url 'onboarding:forge_project_browse' %}" class="text-xs text-indigo-600 hover:text-indigo-800">View All ‚Üí</a>
                </div>
                
                {% if recruiting_projects %}
                <div class="space-y-3">
                    {% for project in recruiting_projects %}
                    <a href="{% url 'onboarding:forge_project_detail' project.id %}" 
                       class="block p-3 border rounded hover:bg-gray-50">
                        <div class="font-medium text-sm text-gray-900">{{ project.project_name }}</div>
                        <div class="text-xs text-gray-500 mt-1">
                            by {{ project.developer.first_name }} {{ project.developer.last_name }}
                        </div>
                        <div class="text-xs text-purple-600 mt-1">
                            Looking for: {{ project.team_size }}
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-sm text-gray-500">No projects currently recruiting.</p>
                {% endif %}
            </div>

            <!-- Quick Links -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="font-semibold text-gray-900 mb-4">Quick Links</h3>
                <div class="space-y-2">
                    <a href="{% url 'onboarding:developer_teams' %}" class="block text-sm text-indigo-600 hover:text-indigo-800">
                        ‚Üí My Teams & Trainings
                    </a>
                    <a href="{% url 'onboarding:developer_certificates' %}" class="block text-sm text-indigo-600 hover:text-indigo-800">
                        ‚Üí My Certificates
                    </a>
                    <a href="{% url 'onboarding:edit_profile' %}" class="block text-sm text-indigo-600 hover:text-indigo-800">
                        ‚Üí Edit Profile
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const startSelect = document.querySelector('[name="availability_start"]');
    const customDateField = document.getElementById('custom_date_field');
    
    if (startSelect && customDateField) {
        startSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                customDateField.classList.remove('hidden');
            } else {
                customDateField.classList.add('hidden');
            }
        });
    }
});
</script>

<style>
    input[type="text"], input[type="url"], input[type="number"], input[type="date"], textarea, select {
        font-size: 0.875rem;
    }
    input:focus, textarea:focus, select:focus {
        outline: none;
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    textarea { resize: vertical; }
</style>
{% endblock %}
